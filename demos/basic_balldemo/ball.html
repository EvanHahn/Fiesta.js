<!DOCTYPE html>
<html>
<head>
	
	<!-- Fiesta -->
	<script src="../../src/namespace.js"></script>
	<script src="../../src/jsclass_core.js"></script>
	<script src="../../src/three_fiesta.js"></script>
	<script src="../../src/stats.js"></script>
	<script src="../../src/config.js"></script>
	<script src="../../src/misc.js"></script>
	<script src="../../src/vector3.js"></script>
	<script src="../../src/math.js"></script>
	<script src="../../src/browser.js"></script>
	<script src="../../src/commands.js"></script>
	<script src="../../src/entity.js"></script>
	<script src="../../src/graphic.js"></script>
	<script src="../../src/graphic2d.js"></script>
	<script src="../../src/graphic3d.js"></script>
	<script src="../../src/sprite2d.js"></script>
	<script src="../../src/box3d.js"></script>
	<script src="../../src/camera3d.js"></script>
	<script src="../../src/light3d.js"></script>
	<script src="../../src/playground.js"></script>
	
</head>
<body>

	<script>
	
	// Config
	var room_width = 500;
	var room_height = 300;
	var gravity = 500;
		
	// Ballin'
	var Ball = new Fiesta.Class(Fiesta.Entity, {
		
		// Constructor
		initialize: function() {
			// Call super
			this.callSuper();
			
			// Sprites
			this._spr_ball = new Fiesta.Sprite2D("ball.gif");
			this._spr_ball.setOrigin(16, 16);
			this.setGraphic(this._spr_ball);
			
			// Config
			this.frict = 100;
			this.velocityBump = 200;
			this.accel = 500;
			this.jumpSpeed = 300;
			
			// Go for it!
			this.setFrictionX(this.frict);
			this.setAccelerationY(gravity);
			this.setMass(10);
		},
		
		// Movement
		moveLeft: function() {
			if (this.getVelocityX() === 0)
				this.setVelocityX(this.velocityBump * -1);
			this.setAccelerationX(this.accel * -1);
		},
		moveRight: function() {
			if (this.getVelocityX() === 0)
				this.setVelocityX(this.velocityBump);
			this.setAccelerationX(this.accel);
		},
		stopX: function() { this.setAccelerationX(0); },
		jump: function() { this.setVelocityY(-this.jumpSpeed); },
		
		// On spawn
		onSpawn: function() {
			this.callSuper();
			Fiesta.bindCommands(this, {
				"left keydown": this.moveLeft,
				"right keydown": this.moveRight,
				"left keyup": this.stopX,
				"right keyup": this.stopX,
				"space keydown": this.jump
			});
		},
		
		// On frame
		onFrame: function() {
			this.callSuper();
			if ((this.getX() < (0 + this.getGraphic().getOriginX())) || (this.getX() >(room_width - this.getGraphic().getOriginX())))
				this.setVelocityX(-this.getVelocityX())
			if (this.getY() >(room_height - this.getGraphic().getOriginY())) {
				this.setVelocityY(this.getVelocityY() * -0.9);
				this.setY(room_height - this.getGraphic().getOriginY());
				if (Math.abs(this.getVelocityY()) < 45)
					this.setVelocityY(0);
			}
		}
		
	});
	
	// Ball spawner
	var BallSpawner = new Fiesta.Class(Fiesta.Entity, {
		
		// Constructor
		intialize: function() {
			this.callSuper();
		},
		
		// Spawn a ball
		spawnBall: function(x, y) {
			var ball = new Ball();
			this.getPlayground().spawn(ball);
			ball.setCoordinates(x, y);
		},
		
		// Delete a ball
		deleteBall: function(x, y) {
			var object = this.getPlayground().objectsAt(x, y);
			if (object) {
				for (var i in object)
					object[i].destroy();
			}
		},
		
		// Bind commmands
		onSpawn: function() {
			this.callSuper();
			Fiesta.bindCommands(this, {
				"left click": this.spawnBall,
				"right click": this.deleteBall
			});
		}
		
	});
	
	// Set up the playground
	var playground = new Fiesta.Playground(room_width, room_height, "2d", 60);
	var ballSpawner = new BallSpawner();
	playground.spawn(ballSpawner);
	
	// Let's go for it!
	playground.setBackgroundColor("#000");
	playground.place(document.body);
	Fiesta.showStats();
	
	</script>

</body>
</html>
