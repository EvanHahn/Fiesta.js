<!DOCTYPE html>
<html>
<head>
	
	<!-- Fiesta -->
	<script src="../../fiesta.js"></script>
	
</head>
<body>

	<script>
	
	// Config
	var room_width = 800;
	var room_height = 300;
		
	// Ballin'
	var Ball = new Fiesta.Class(Fiesta.PhysicalGameObject, function() {
		
		// Config
		var ballSpriteURL = "ball.gif";
		var ballOriginX = 16;
		var ballOriginY = 16;
		var velocityBump = 200;
		var acceleration = 500;
		var jumpSpeed = 300;
		
		// On spawn
		this.onSpawn = function() {
			
			// Call superclass
			this.parent.onSpawn();
			
			// Bind commands
			Fiesta.bindCommands(this, {
				"left keydown": this.moveLeft,
				"right keydown": this.moveRight,
				"left keyup": this.stopX,
				"right keyup": this.stopX,
				"space keydown": this.jump
			});
			
			// Sprite
			var sprite = new Fiesta.Sprite(ballSpriteURL);
			sprite.setOrigin(ballOriginX, ballOriginY);
			this.setGraphic(sprite);
			
			// Physics
			this.setFrictionX(100);
			this.setVelocityY(1);
			this.setAccelerationY(100);
			this.setMass(10);
			
		};
		
		// Movement
		this.moveLeft = function() {
			if (this.getVelocityX() === 0)
				this.setVelocityX(this._velocityBump * -1);
			this.setAccelerationX(this._acceleration * -1);
		};
		this.moveRight = function() {
			if (this.getVelocityX() === 0)
				this.setVelocityX(this._velocityBump);
			this.setAccelerationX(this._acceleration);
		};
		this.stopX = function() { this.setAccelerationX(0); };
		this.jump = function() { this.setVelocityY(-this._jumpSpeed); };
		
		// On frame
		this.onFrame = function() {
			this.parent.onFrame();
			Fiesta.log(this);
			if ((this.getX() < (0 + this.getGraphic().getOriginX())) || (this.getX() > (room_width - this.getGraphic().getOriginX())))
				this.setVelocityX(-this.getVelocityX())
			if (this.getY() > (room_height - this.getGraphic().getOriginY())) {
				this.setVelocityY(this.getVelocityY() * -0.9);
				this.setY(room_height - this.getGraphic().getOriginY());
				if (Math.abs(this.getVelocityY()) < 45)
					this.setVelocityY(0);
			}
		};
		
	});
	
	// Ball spawner
	var BallSpawner = new Fiesta.Class(Fiesta.GameObject, function() {
		
		// Spawn a ball
		this.spawnBall = function(x, y) {
			var ball = new Ball();
			this.getPlayground().spawn(ball);
			ball.setCoordinates(x, y);
		};
		
		// Delete a ball
		this.deleteBall = function(x, y) {
			var object = this.getPlayground().objectsAt(x, y);
			if (object) {
				for (var i in object)
					object[i].destroy();
			}
		};
		
		// Bind commmands
		this.onSpawn = function() {
			this.parent.onSpawn();
			Fiesta.bindCommands(this, {
				"left click": this.spawnBall,
				"right click": this.deleteBall
			});
		};
		
	});
	
	// Set up the playground
	var playground = new Fiesta.Playground(room_width, room_height, "2d", 1);
	var ballSpawner = new BallSpawner();
	playground.spawn(ballSpawner);
	
	// Let's go for it!
	playground.setBackgroundColor("#000");
	playground.place(document.body);
	
	</script>

</body>
</html>
